<!doctype html>
<html lang="en-CA">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Premium Supply — Checkout</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="styles.css" />
</head>

<body data-page="checkout">
  <!-- Topbar -->
  <div class="topbar">
    <div class="container topbar__inner">
      <span class="topbar__badge"><i class="fa-solid fa-maple-leaf"></i> 100% Canadian</span>
      <p class="topbar__text">Checkout</p>
      <a class="topbar__link" href="cart.html">Back to cart</a>
    </div>
  </div>

  <main class="section">
    <div class="container">
      <div class="cart-layout">
        <!-- LEFT: actions + confirmation -->
        <section class="card">
          <h1 class="block__title" style="margin:0 0 8px;">Place your order</h1>
          <p class="muted" style="margin:0 0 12px;">
            Review your cart on the right. When you click <strong>Place order</strong>, we’ll generate an Order ID and show your order summary + payment instructions.
            <br><br>
            <strong>No external services are used.</strong> Your confirmation is stored on this device/browser.
          </p>

          <button class="btn btn--solid btn--full" id="placeOrderBtn" type="button">
            Place order
          </button>

          <a class="btn btn--outline btn--full" href="products.html" style="margin-top:10px;">
            Continue shopping
          </a>

          <!-- Confirmation panel -->
          <div id="confirmWrap" style="display:none; margin-top:14px;">
            <div class="alert-danger" id="policyWarning">
              If you don't pay in the next 24 hours for the order your account will be closed in 48 hours
            </div>

            <div class="kv">
              <span class="label">Order ID:</span>
              <span class="value mono" id="orderIdText">—</span>
            </div>

            <div class="kv">
              <span class="label">Pay by:</span>
              <span class="value" id="payByText">—</span>
            </div>

            <div class="kv">
              <span class="label">Time left:</span>
              <span class="value" id="timeLeftText">—</span>
            </div>

            <div class="card" style="margin-top:12px;">
              <h2 class="block__title" style="margin:0 0 8px; font-size:1.15rem;">Payment instructions</h2>
              <p class="muted" style="margin:0;">
                Send <strong>Interac e‑Transfer</strong> to:
                <span class="mono" id="payEmail">payments@premiumsupply.ca</span>
                <br>
                Use your <strong>Order ID</strong> as the reference/message:
                <span class="mono" id="payRef">—</span>
              </p>
            </div>

            <h3 class="block__title" style="margin:14px 0 8px; font-size:1.05rem;">Order summary</h3>
            <div class="codebox" id="summaryBox">—</div>

            <div class="confirm-actions">
              <button class="btn btn--outline" type="button" id="copySummaryBtn">
                Copy summary
              </button>
              <button class="btn btn--outline" type="button" id="downloadSummaryBtn">
                Download summary
              </button>
              <button class="btn btn--outline" type="button" id="restoreCartBtn">
                Restore cart
              </button>
              <a class="btn btn--solid" href="products.html">
                Done
              </a>
            </div>

            <p class="muted" style="margin:10px 0 0;">
              Tip: screenshot this page or download the summary for your records.
            </p>
          </div>
        </section>

        <!-- RIGHT: review -->
        <aside class="card">
          <h2 class="block__title" style="margin:0 0 8px;">Review</h2>
          <div id="reviewItems"></div>

          <div class="hr"></div>
          <div class="summary-row"><span>Subtotal</span> <strong id="subtotal">$0.00</strong></div>
          <div class="summary-row"><span>Shipping</span> <strong id="shipping">$0.00</strong></div>
          <div class="summary-row"><span>Total</span> <strong id="total">$0.00</strong></div>

          <p class="muted" style="margin:10px 0 0;">
            Need to change quantity or remove items? <a href="cart.html" style="text-decoration:underline; font-weight:950;">Edit cart</a>.
          </p>
        </aside>
      </div>
    </div>
  </main>

  <script>
    const PS = {
      currency: "CAD",
      cartKey: "ps_cart_v1",
      lastOrderKey: "ps_last_order_v1",
      // Update this to your real Interac email:
      paymentEmail: "payments@premiumsupply.ca",
      // optional shipping logic:
      freeShipOver: 150,
      flatShip: 15
    };

    const $ = (s, el=document) => el.querySelector(s);
    const money = (n) => new Intl.NumberFormat("en-CA", { style:"currency", currency: PS.currency }).format(n);

    function readCart(){ try { return JSON.parse(localStorage.getItem(PS.cartKey) || "{}"); } catch { return {}; } }
    function writeCart(cart){ localStorage.setItem(PS.cartKey, JSON.stringify(cart)); }

    function readLastOrder(){ try { return JSON.parse(localStorage.getItem(PS.lastOrderKey) || "null"); } catch { return null; } }
    function writeLastOrder(order){ localStorage.setItem(PS.lastOrderKey, JSON.stringify(order)); }

    function calc(cart){
      const items = Object.values(cart);
      const subtotal = items.reduce((s,i)=> s + (i.price*i.qty), 0);
      const shipping = subtotal >= PS.freeShipOver ? 0 : (items.length ? PS.flatShip : 0);
      const total = subtotal + shipping;
      return { items, subtotal, shipping, total };
    }

    function makeOrderId(){
      const now = Date.now().toString(36).toUpperCase();
      const rnd = Math.random().toString(36).slice(2,6).toUpperCase();
      return `PS-${now}-${rnd}`;
    }

    function fmtDateTime(ms){
      return new Intl.DateTimeFormat("en-CA", { dateStyle:"medium", timeStyle:"short" }).format(new Date(ms));
    }

    function fmtCountdown(msLeft){
      const s = Math.max(0, Math.floor(msLeft / 1000));
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h}h ${m}m ${sec}s`;
    }

    function buildSummary(order){
      const lines = [];
      lines.push(`Premium Supply — Order Summary`);
      lines.push(`Order ID: ${order.orderId}`);
      lines.push(`Created: ${fmtDateTime(order.createdAt)}`);
      lines.push(`Pay by: ${fmtDateTime(order.payByAt)} (24 hours)`);
      lines.push(`Account closure time: ${fmtDateTime(order.closeAt)} (48 hours)`);
      lines.push("");
      lines.push("Items:");
      order.items.forEach(i => {
        lines.push(`- ${i.qty} x ${i.name} @ ${money(i.price)} (${i.category} • ${i.tier} • ${i.type})`);
      });
      lines.push("");
      lines.push(`Subtotal: ${money(order.subtotal)}`);
      lines.push(`Shipping: ${money(order.shipping)}`);
      lines.push(`Total: ${money(order.total)}`);
      lines.push("");
      lines.push(`Payment: Interac e‑Transfer to ${PS.paymentEmail}`);
      lines.push(`Reference/Message: ${order.orderId}`);
      return lines.join("\n");
    }

    function renderReview(){
      const cart = readCart();
      const totals = calc(cart);

      $("#subtotal").textContent = money(totals.subtotal);
      $("#shipping").textContent = money(totals.shipping);
      $("#total").textContent = money(totals.total);

      if(!totals.items.length){
        $("#reviewItems").innerHTML =
          `<p class="muted">Your cart is empty. <a href="products.html" style="text-decoration:underline;font-weight:950;">Shop products</a>.</p>`;
        $("#placeOrderBtn").disabled = true;
        $("#placeOrderBtn").style.opacity = ".6";
        $("#placeOrderBtn").style.cursor = "not-allowed";
        return;
      }

      $("#placeOrderBtn").disabled = false;
      $("#placeOrderBtn").style.opacity = "1";
      $("#placeOrderBtn").style.cursor = "pointer";

      $("#reviewItems").innerHTML = totals.items.map(i => `
        <div class="cart-item" style="grid-template-columns: 60px 1fr;">
          <div class="cart-thumb" style="width:60px;height:60px;" aria-hidden="true"></div>
          <div class="cart-meta">
            <h3 style="margin:0;font-size:.98rem;">${i.name}</h3>
            <div class="meta">${i.category} • ${i.tier} • ${i.type}</div>
            <div class="meta"><strong>${i.qty}</strong> × ${money(i.price)}</div>
          </div>
        </div>
      `).join("");
    }

    let countdownTimer = null;

    function showConfirmation(order){
      // stop old timer
      if(countdownTimer) window.clearInterval(countdownTimer);

      $("#confirmWrap").style.display = "block";
      $("#orderIdText").textContent = order.orderId;
      $("#payByText").textContent = fmtDateTime(order.payByAt);
      $("#payEmail").textContent = PS.paymentEmail;
      $("#payRef").textContent = order.orderId;

      const summary = buildSummary(order);
      $("#summaryBox").textContent = summary;

      // live countdown
      function tick(){
        const msLeft = order.payByAt - Date.now();
        $("#timeLeftText").textContent = fmtCountdown(msLeft);
      }
      tick();
      countdownTimer = window.setInterval(tick, 1000);

      // Copy
      $("#copySummaryBtn").onclick = async () => {
        try{
          await navigator.clipboard.writeText(summary);
          $("#copySummaryBtn").textContent = "Copied ✓";
          setTimeout(() => $("#copySummaryBtn").textContent = "Copy summary", 1200);
        }catch{
          alert("Copy failed on this browser. Please select and copy manually.");
        }
      };

      // Download
      $("#downloadSummaryBtn").onclick = () => {
        const blob = new Blob([summary], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${order.orderId}.txt`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      // Restore cart
      $("#restoreCartBtn").onclick = () => {
        if(order.cartSnapshot){
          writeCart(order.cartSnapshot);
          location.href = "cart.html";
        } else {
          alert("No cart snapshot found to restore.");
        }
      };
    }

    // Place order action
    $("#placeOrderBtn").addEventListener("click", () => {
      const cart = readCart();
      const totals = calc(cart);

      if(!totals.items.length){
        alert("Your cart is empty.");
        return;
      }

      const createdAt = Date.now();
      const order = {
        orderId: makeOrderId(),
        createdAt,
        payByAt: createdAt + 24 * 60 * 60 * 1000,
        closeAt: createdAt + 48 * 60 * 60 * 1000,

        items: totals.items,
        subtotal: totals.subtotal,
        shipping: totals.shipping,
        total: totals.total,

        // store cart snapshot so the user can restore it
        cartSnapshot: cart
      };

      // Save "last order" locally
      writeLastOrder(order);

      // Optional: clear cart after placing order (typical checkout UX)
      writeCart({});

      renderReview();
      showConfirmation(order);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // On load: render review + show last saved order (if exists)
    renderReview();

    const last = readLastOrder();
    if(last && last.orderId){
      // If there is a saved order, show it so refresh doesn't lose it
      showConfirmation(last);
    }
  </script>
</body>
</html>